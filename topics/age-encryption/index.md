## Definition

An age file is composed of two parts: a textual header that carries the file key, and a binary payload encrypted with it. Overall, age files MUST be treated as binary, and are not malleable without knowledge of the file key.

Age file can be binary format or armored (ASCII armor) format

### File key
Each file is encrypted with a 128-bit symmetric file key. The file key MUST be generated as 16 bytes of CSPRNG output. It MUST NOT be reused across multiple files.

### Header
The textual file header wraps the file key for one or more recipients, so that it can be unwrapped by one of the corresponding identities. It starts with a version line, followed by one or more recipient stanzas, and ends with a MAC.

```
age-encryption.org/v1
-> X25519 XEl0dJ6y3C7KZkgmgWUicg63EyXJiwBJW8PdYJ/cYBE
qRS0AMjdjPvZ/WT08U2KL4G+PIooA3hy38SvLpvaC1E
--- HK2NmOBN9Dpq0Gw6xMCuhFcQlQLvZ/wQUi/2scLG75s
```
The version line always starts with "age-encryption.org/", is followed by an arbitrary version string, and ends with a line feed (0x0A).

A recipient stanza starts with -> followed after a space by one or more space-separated arguments, and a base64-encoded body wrapped at 64 columns. The body MUST end with a line shorter than 64 characters, which MAY be empty.

The final header line starts with --- and is followed after a space by the base64-encoded MAC of the header. The MAC is computed with HMAC-SHA-256 (see RFC 2104) over the whole header up to and including the --- mark (excluding the space following it).

The following is the ABNF definition of the v1 file header.

```
header = v1-line 1*stanza end

v1-line = %s"age-encryption.org/v1" LF

end = "--- " 43base64char LF

base64char = ALPHA / DIGIT / "+" / "/"

stanza = arg-line *full-line final-line

arg-line = "-> " argument *(SP argument) LF

argument = 1*VCHAR

full-line = 64base64char LF

final-line = *63base64char LF
```

### Payload

The binary payload encrypts the file body and starts immediately after the header. It begins with a 16-byte nonce generated by the sender from a CSPRNG. A new nonce MUST be generated for each file.
```
payload key = HKDF-SHA-256(ikm = file key, salt = nonce, info = "payload")
```

### Recipient

Two types of recipients
1)  asymmetric encryption
    - asymmetric encryption type based on X25519
    -  An X25519 identity is generated as `identity = read(CSPRNG, 32)` and encoded as Bech32 with HRP `AGE-SECRET-KEY- (AGE-SECRET-KEY-1GFPYYSJZGFPYYSJZGFPYYSJZGFPYYSJZGFPYYSJZGFPYYSJZGFPQ4EGAEX)`
    - The corresponding recipient is computed as `recipient = X25519(identity, basepoint)` where X25519 is from RFC 7748, Section 5, and basepoint is the Curve25519 base point from RFC 7748, Section 4.1.
    - The recipient is encoded as Bech32 with HRP age.  Bech32 strings can only be all uppercase or all lowercase, but the checksum is always computed over the lowercase string.
    - An X25519 recipient stanza has two arguments. X25519 recipient stanza. The first is the fixed string X25519 and the second is the base64-encoded ephemeral share computed by the recipient implementation
        - `X25519 O6DLx/wDIawpUC978NSPjYvrfDtJVnZApXKp4FMPHCY3aKjozt9agh7jGmvOKvR4iax41Wl4zj95MKK4X9JuWc`        
    - Anotomy of the ephemeral 
        ```
        ephemeral secret = read(CSPRNG, 32)ephemeral share = X25519(ephemeral secret, basepoint)
        ```
        A new ephemeral secret MUST be generated for each stanza and each file.
    - The body of the recipient stanza is computed by the recipient implementation as 
        ```
        salt = ephemeral share || recipient
        info = "age-encryption.org/v1/X25519"
        shared secret = X25519(ephemeral secret, recipient)
        wrap key = HKDF-SHA-256(ikm = shared secret, salt, info)
        body = ChaCha20-Poly1305(key = wrap key, plaintext = file key)
        ```
    - The identity implementation computes the shared secret as follows:
        ```
        shared secret = X25519(identity, ephemeral share)
        ``` 
2)  passphrase encryption
   - The scrypt recipient and identity implementations encrypt and decrypt the file key with a provided passphrase.
   - scrypt recipient stanza
     - An scrypt recipient stanza has three arguments. ```-> scrypt ajMFur+EJLGaohv/dLRGnw 18 8SHBz/ldWnjyGFQqfjat6uNBarWqqEMDS7W8X7+Xq5Q```
     - The first is the string scrypt, the second is a base64-encoded salt computed by the recipient implementation as 16 bytes from a CSPRNG, and the third is the base-two logarithm of the scrypt work factor in decimal.
     - A new salt MUST be generated for each stanza and each file.
     - The body is computed as
        ```
        wrap key = scrypt(N = work factor, r = 8, p = 1, dkLen = 32,
        S = "age-encryption.org/v1/scrypt" || salt, P = passphrase)
        body = ChaCha20-Poly1305(key = wrap key, plaintext = file key)
        ```



####

## Glossery

* **CSPRNG** : cryptographically secure pseudorandom number generator  [LINK](https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator)
* **Bech32 with HRP** : Bech32 is a checksummed base32 format. It is being used in cryptocurrencies development (bitcoin, cardano,…) A Bech32 is consist of three parts, the human readable part(hrp) the separator (always “1”) and the data part.  [LINK](http://trikalabs.com/bech32-algorithm/#:~:text=A%20Bech32%20is%20consist%20of%20three%20parts%2C%20the,%2B%201%20%2B%20Transformed%20%28input%20data%20%2B%20checksum%29.)
*  **X25519**: X25519 is an elliptic curve Diffie-Hellman key exchange using Curve25519. It allows two parties to jointly agree on a shared secret using an insecure channel.9 [LINK_1](https://www.rfc-editor.org/rfc/rfc7748#section-5) [LINK_2](https://x25519.xargs.org/)
*  **ABNF**:  augmented Backus–Naur form.  The motive principle for ABNF is to describe a formal system of a language to be used as a bidirectional communications protocol [LINK](https://en.wikipedia.org/wiki/Augmented_Backus%E2%80%93Naur_form)

## Reference

* [Github PAGE](https://github.com/C2SP/C2SP/blob/main/age.md)
* 